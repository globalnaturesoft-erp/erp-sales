<% tabid = unique_id %>
<div class="tabbable-custom ">
    <ul class="nav nav-tabs ">
        <li class="active">
            <a href="#tab_<%= tabid %>_1" data-toggle="tab">
                <i class="glyphicon glyphicon-list-alt"></i>
                <%= t('.order_details') %>
            </a>
        </li>

        <% if @order.get_order_stock_check.present? and @order.get_order_stock_check.is_done? %>
            <li>
                <a href="#tab_<%= tabid %>_2" data-toggle="tab">
                    <i class="glyphicon glyphicon-check"></i>
                    <%= t('.order_stock_check_details') %>
                </a>
            </li>
        <% end %>
        
        <li>
            <a href="#tab_<%= tabid %>_3" data-toggle="tab">
                <i class="fa fa-history"></i>
                <%= 'Lịch sử giao hàng' %>
            </a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="tab_<%= tabid %>_1">
            <div class="table-scrollable">
                <table class="table table-bordered table-advance order-column">
                    <thead class="flip-content">
                        <tr>
                            <th class="text-left bg-yellow bg-font-yellow text-nowrap" width="20%">Tên sản phẩm</th>
                            <th class="bg-yellow bg-font-yellow text-nowrap">ĐVT</th>
                            <th class="bg-yellow bg-font-yellow text-nowrap">Kho đặt</th>
                            <th class="text-center bg-yellow bg-font-yellow text-nowrap">Số lô</th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap">Giá bán<sup>(1)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap">Số lượng<sup>(2)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap" title="(3) = (1) x (2)">Thành tiền<sup>(3)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap">Giảm<sup>(4)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap" title="Tổng tiền trước thuế: (6) = (3) - (4) + (5)">Tổng cộng<sup>(6)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap">Tiền VAT<sup>(7)</sup></th>
                            <th class="text-right bg-yellow bg-font-yellow text-nowrap" title="Tổng cần thanh toán (đã gồm VAT): (8) = (6) + (7)">Tổng thanh toán<sup>(8)</sup></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="bg-green" colspan="5"><strong> TỔNG CỘNG </strong></td>
                            <td class="bg-green text-right"><strong><%= @order.items_count %></strong></td>
                            <td class="bg-green text-right"><strong><%= format_price(@order.subtotal) %></strong></td>
                            <td class="bg-green text-right"><strong><%= @order.discount_amount == 0 ? '' : format_price(@order.discount_amount) %></strong></td>
                            <td class="bg-green text-right"><strong><%= format_price(@order.total_without_tax) %></strong></td>
                            <td class="bg-green text-right"><strong><%= format_price(@order.cache_tax_amount) %></strong></td>
                            <td class="bg-green text-right"><strong><%= format_price(@order.cache_total) %></strong></td>
                        </tr>
                        <% @order.order_details.each do |order_detail| %>
                            <tr>
                                <td class="text-left"><strong><%= order_detail.product_name %></strong></td>
                                <td class="text-left"><%= order_detail.product_unit_name %></td>
                                <td class="text-left"><%= order_detail.warehouse_name %></td>
                                <td class="text-left"><%= order_detail.serials %></td>
                                <td class="text-right"><%= format_price(order_detail.price) %></td>
                                <td class="text-right"><%= format_number(order_detail.quantity) %></td>
                                <td class="text-right"><%= format_price(order_detail.subtotal) %></td>
                                <td class="text-right"><%= order_detail.discount.nil? ? '' : format_price(order_detail.discount) %></td>
                                <td class="text-right"><%= format_price(order_detail.total_without_tax) %></td>
                                <td class="text-right"><%= format_price(order_detail.tax_amount) %></td>
                                <td class="text-right"><%= format_price(order_detail.total) %></td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>

        <% if @order.get_order_stock_check.present? and @order.get_order_stock_check.is_done? %>
            <div class="tab-pane" id="tab_<%= tabid %>_2">
                <div class="table-scrollable">
                    <table class="table table-bordered table-advance order-column">
                        <thead class="flip-content">
                            <tr>
                                <th class="text-left bg-yellow bg-font-yellow text-nowrap" width="20%">Tên sản phẩm</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap">Đơn vị tính</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-right">Giá bán</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-right">Số lượng</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-center">Hàng đang có sẵn</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-left">Hàng thay thế</th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-left">Số lô</th>
                                <th width="20%" class="bg-yellow bg-font-yellow text-nowrap text-left">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% @order.schecks.last.scheck_details.order('created_at desc').each do |scheck_detail| %>
                            <tr>
                                <td class="text-left"><strong><%= scheck_detail.order_detail.product_name %></strong></td>
                                <td class="text-left"><%= scheck_detail.order_detail.product_unit_name %></td>
                                <td class="text-right"><%= format_price(scheck_detail.order_detail.price) %></td>
                                <td class="text-right"><%= scheck_detail.order_detail.quantity %></td>
                                <td class="text-center">
                                    <%= raw scheck_detail.available? ? '<i class="fa fa-check font-green-jungle"></i>' : '<i class="fa fa-close font-red-thunderbird"></i>' %>
                                </td>                                
                                <td class="text-left">
                                    <table width="100%">
                                        <% scheck_detail.get_alternative_items.each do |item| %>
                                            <tr>
                                                <td width="1%" class="text-nowrap text-left"><div class="badge badge-info"><%= item[:index] %></div></td>
                                                <td class="text-nowrap text-left"><%= item[:product].name %></td>
                                            </tr>
                                        <% end %>
                                    </table>
                                </td>
                                <td class="text-left"><%= scheck_detail.serials %></td>
                                <td class="text-left"><%= scheck_detail.note %></td>
                            </tr>
                            <% end %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% end %>
        
        <div class="tab-pane" id="tab_<%= tabid %>_3">
            <div class="table-scrollable">
                <table class="table table-bordered table-striped flip-content table-child-content">
                    <thead class="flip-content">
                        <tr>
                            <% if !Erp::Core.available?("ortho_k") %>
                                <th width="15%" class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'Mã sản phẩm' %></th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-left"><%= 'Tên sản phẩm' %></th>
                                <th class="bg-yellow bg-font-yellow text-nowrap text-left"><%= 'Loại' %></th>
                            <% else %>
                                <th width="20%" class="bg-yellow bg-font-yellow text-nowrap text-left"><%= 'Tên sản phẩm' %></th>
                            <% end %>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'ĐVT' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'Kho đặt' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'Kho xuất' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'SL đặt' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'SL đã giao' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'SL còn lại' %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= t('status') %></th>
                            <th class="bg-yellow bg-font-yellow text-nowrap text-center"><%= 'Phiếu giao hàng' %></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @order.order_details.each do |order_detail| %>
                            <% if order_detail.delivered_delivery_details.count > 0 %>
                                <tr class="odd gradeX has-child-table" data-url="<%= erp_qdeliveries.backend_deliveries_sales_path(id: order_detail.id) %>">
                            <% else %>
                                <tr>
                            <% end %>
                                <% if !Erp::Core.available?("ortho_k") %>
                                    <td class="text-left">
                                        <% if order_detail.delivered_delivery_details.count > 0 %>
                                            <i class="fa fa-plus expand tr-expand-button child-tr-expand-button"></i>
                                        <% end %>
                                        <strong><%= order_detail.product_code %></strong>
                                    </td>
                                    <td class="text-left">
                                        <%= link_to order_detail.product_name,
                                            erp_products.edit_backend_product_path(order_detail.product),
                                            target: "_blank", title: order_detail.product_name,
                                            class: "font-yellow-gold sbold" %>
                                    </td>
                                    <td class="text-left"><%= order_detail.product_category_name %></td>
                                <% else %>
                                    <td class="text-left">
                                        <% if order_detail.delivered_delivery_details.count > 0 %>
                                            <i class="fa fa-plus expand tr-expand-button child-tr-expand-button"></i>
                                        <% end %>
                                        <strong>
                                            <%= backend_product_link(order_detail.product) %>
                                        </strong>
                                    </td>
                                <% end %>
                                <td class="text-center"><%= order_detail.product_unit_name %></td>
                                <td class="text-center"><%= order_detail.warehouse_name %></td>
                                <td class="text-center"><%= order_detail.get_delivery_warehouse_export.present? ? order_detail.get_delivery_warehouse_export : '--' %></td>
                                <td class="numeric text-center bold"><%= format_number(order_detail.quantity) %></td>
                                <td class="numeric text-center bold"><%= format_number(order_detail.delivered_quantity) %></td>
                                <td class="numeric text-center bold"><%= format_number(order_detail.not_delivered_quantity) %></td>
                                <td class="text-center">
                                    <% if order_detail.not_delivered_quantity > 0 %>
                                        <span class="font-yellow-gold">Chưa giao xong</span>
                                    <% elsif order_detail.not_delivered_quantity == 0 %>
                                        <span class="font-green-meadow">Đã giao xong</span>
                                    <% else %>
                                        <span class="font-red-thunderbird">Giao bị dư</span>
                                    <% end %>
                                </td>
                                <td class="text-center">
                                    <% if order_detail.delivered_delivery_details.count > 0 %>
                                        <% order_detail.delivered_delivery_details.each do |delivery_detail| %>
                                            <%= qdelivery_link(delivery_detail.delivery) %>
                                            <br>
                                        <% end %>
                                    <% else %>
                                        --
                                    <% end %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div
